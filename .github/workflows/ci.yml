name: CI

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

jobs:
  build:
    name: ${{ matrix.os }} - ${{ matrix.compiler }}
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        include:
          # Ubuntu with GCC 14 (latest available on Ubuntu 24.04)
          - os: ubuntu-24.04
            compiler: gcc-14
            cc: gcc-14
            cxx: g++-14

          # Ubuntu with Clang 21 (latest)
          - os: ubuntu-24.04
            compiler: clang-21
            cc: clang-21
            cxx: clang++-21

          # macOS with Homebrew GCC 15 (NOT Apple Clang)
          - os: macos-latest
            compiler: gcc-15
            cc: gcc-15
            cxx: g++-15

          # macOS with Homebrew Clang/LLVM 21 (NOT Apple Clang)
          - os: macos-latest
            compiler: llvm-21
            cc: /opt/homebrew/opt/llvm/bin/clang
            cxx: /opt/homebrew/opt/llvm/bin/clang++

          # Windows with MSVC latest
          - os: windows-latest
            compiler: msvc
            cc: cl
            cxx: cl

    steps:
    - name: Checkout repository
      uses: actions/checkout@v6

    # ========================================================================
    # Install latest CMake (4.1.2 or higher)
    # ========================================================================
    - name: Install latest CMake
      uses: lukka/get-cmake@latest
      with:
        cmakeVersion: "~4.1.0"

    # ========================================================================
    # Install Compilers
    # ========================================================================
    # Ubuntu: GCC 14 available in main repos, use LLVM repo for Clang
    - name: Install GCC 14 (Ubuntu)
      if: matrix.compiler == 'gcc-14' && runner.os == 'Linux'
      run: |
        sudo apt update
        sudo apt install -y gcc-14 g++-14

    - name: Install Clang 21 (Ubuntu)
      if: matrix.compiler == 'clang-21' && runner.os == 'Linux'
      run: |
        wget -qO- https://apt.llvm.org/llvm-snapshot.gpg.key | sudo tee /etc/apt/trusted.gpg.d/apt.llvm.org.asc
        sudo add-apt-repository "deb http://apt.llvm.org/noble/ llvm-toolchain-noble-21 main" -y
        sudo apt update
        sudo apt install -y clang-21 libc++-21-dev libc++abi-21-dev

    # macOS: Use Homebrew for both GCC and LLVM
    - name: Install GCC 15 (macOS)
      if: matrix.compiler == 'gcc-15' && runner.os == 'macOS'
      run: brew install gcc@15

    - name: Install LLVM 21 (macOS)
      if: matrix.compiler == 'llvm-21' && runner.os == 'macOS'
      run: brew install llvm@21

    # ========================================================================
    # Note: Catch2 is fetched automatically via CMake FetchContent
    # ========================================================================
    # Verify compiler versions
    # ========================================================================
    - name: Verify compiler versions
      if: runner.os != 'Windows'
      run: |
        echo "=== Compiler Information ==="
        ${{ matrix.cc }} --version
        ${{ matrix.cxx }} --version
        cmake --version
        echo "Expected: GCC 14.x (Ubuntu) / 15.x (macOS) or Clang 21.x"
        echo "Expected: CMake 4.1.2+"

    # ========================================================================
    # Configure with CMake
    # ========================================================================
    - name: Configure with CMake (Unix)
      if: runner.os != 'Windows'
      run: |
        # Set compiler flags for Clang to use libc++ on Linux
        if [[ "${{ matrix.compiler }}" == clang-* ]] && [[ "${{ runner.os }}" == "Linux" ]]; then
          export CXXFLAGS="-stdlib=libc++"
          export LDFLAGS="-stdlib=libc++ -lc++abi"
        fi
        cmake -S . -B build \
          -DCMAKE_C_COMPILER=${{ matrix.cc }} \
          -DCMAKE_CXX_COMPILER=${{ matrix.cxx }} \
          -DCMAKE_BUILD_TYPE=Release

    - name: Configure with CMake (Windows)
      if: runner.os == 'Windows'
      run: |
        cmake -S . -B build `
          -DCMAKE_BUILD_TYPE=Release

    # ========================================================================
    # Build and Test
    # ========================================================================
    - name: Build
      run: cmake --build build --config Release

    - name: Run tests
      run: ctest --test-dir build --output-on-failure --build-config Release

    # ========================================================================
    # Display C++23 feature test
    # ========================================================================
    - name: Show C++23 features in action (Unix)
      if: runner.os != 'Windows'
      run: |
        echo "=== Running C++23 Feature Tests ==="
        ./build/tests "[cpp23]" || true

    - name: Show C++23 features in action (Windows)
      if: runner.os == 'Windows'
      run: |
        echo "=== Running C++23 Feature Tests ==="
        .\build\Release\tests.exe "[cpp23]"
      continue-on-error: true
